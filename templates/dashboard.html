<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LittlePilot">
    <link rel="apple-touch-icon" href="/static/icon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#f4f3f9" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <title>LittlePilot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <style>
        :root {
            --app-bg: #f4f3f9; --card-bg: #FFFFFF; --text-main: #1C1C1E; --text-sub: #A8A8A8; 
            --border-color: #e5e5ea; --input-bg: #FFFFFF; --input-border: #e5e5ea;
            --modal-overlay: rgba(0,0,0,0.5); --badge-bg: #f4f3f9;
            --nav-bg: #454545; --nav-item-bg: rgba(0, 0, 0, 0.25); 
            --nav-text-normal: rgba(255, 255, 255, 0.5); --nav-text-active: #FFFFFF;
            --nav-bg-active: rgba(255, 255, 255, 0.15);
            --icon-btn-active: rgba(0,0,0,0.05); --icon-color: #A8A8A8;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --app-bg: #000000; --card-bg: #1C1C1E; --text-main: #FFFFFF; --text-sub: #A8A8A8; 
                --border-color: #38383A; --input-bg: #2C2C2E; --input-border: #3A3A3C;
                --modal-overlay: rgba(0,0,0,0.8); --badge-bg: #2C2C2E;
                --nav-bg: rgba(118, 118, 128, 0.24); --nav-item-bg: rgba(0, 0, 0, 0.2); 
                --nav-text-normal: rgba(255, 255, 255, 0.5); --nav-text-active: #FFFFFF;
                --nav-bg-active: rgba(255, 255, 255, 0.15);
                --icon-btn-active: rgba(255,255,255,0.1); --icon-color: #A8A8A8;
            }
        }
        html, body { overflow-x: hidden; width: 100%; }
        body { background-color: var(--app-bg); color: var(--text-main); font-family: -apple-system, "SF Pro Display", "Microsoft YaHei", sans-serif; padding-top: env(safe-area-inset-top); padding-bottom: calc(80px + env(safe-area-inset-bottom)); transition: background-color 0.3s, color 0.3s; }
        [v-cloak] { display: none; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(65px + env(safe-area-inset-bottom)); padding-bottom: env(safe-area-inset-bottom); background: var(--nav-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: none; box-shadow: 0 -2px 15px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; z-index: 1000; transition: background-color 0.3s; }
        .nav-tabs-c { background: var(--nav-item-bg); padding: 4px; border-radius: 50px; display: flex; }
        .nav-item-c { color: var(--nav-text-normal); padding: 6px 20px; border-radius: 50px; cursor: pointer; text-decoration: none; font-weight: 600; font-size: 0.95rem; transition: 0.3s; user-select: none; }
        .nav-item-c.active { background: var(--nav-bg-active); color: var(--nav-text-active); }
        .big-title { font-size: 34px; font-weight: 800; color: var(--text-main); margin: 0; letter-spacing: -0.02em; padding-left: 5px; }
        .page-header { margin-top: 20px; margin-bottom: 20px; display: flex; align-items: center; min-height: 42px; }
        .scale-container { max-width: 800px; margin: 0 auto; padding: 15px; min-height: 80vh; transform-origin: top center; }
        @media (max-width: 768px) { .scale-container { transform: scale(0.96); padding-top: 10px; } }
        .apple-card { background: var(--card-bg); border-radius: 24px; padding: 16px; margin-bottom: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.025); color: var(--text-main); transition: background-color 0.3s; }
        
        .status-badge { display: inline-flex; align-items: center; transition: all 0.3s ease; font-size: 0.85rem; font-weight: 600; }
        .static-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; flex-shrink: 0; box-sizing: border-box; transition: all 0.3s ease; }
        .status-running { color: #34C759; } .status-running .static-dot { background-color: #34C759; box-shadow: 0 0 6px rgba(52, 199, 89, 0.4); }
        .status-standby { color: #34C759; } .status-standby .static-dot { background-color: #34C759; }
        .status-offline { color: #A8A8A8; } .status-offline .static-dot { background-color: #A8A8A8; }
        .status-warning { color: #FF9500; } .status-warning .static-dot { background-color: #FF9500; }

        .hl-card { background: var(--card-bg); border-radius: 24px; padding: 16px 12px; height: 110px; box-shadow: 0 6px 20px rgba(0,0,0,0.025); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: background-color 0.3s; }
        .hl-num { font-size: 2.4rem; font-weight: 800; line-height: 1; margin-bottom: 6px; font-family: ui-rounded, "SF Pro Rounded", -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif; }
        .hl-label { font-size: 0.85rem; color: var(--text-sub); font-weight: 500; }
        .num-account { color: var(--text-main); } .num-total { color: #5ec26b; } 
        
        .list-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .list-row:last-child { border-bottom: none; padding-bottom: 0; }
        .rank-container { max-height: 60vh; overflow-y: auto; padding-right: 5px; }
        .rank-container::-webkit-scrollbar { width: 4px; } .rank-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        
        .accordion-item { border: none; border-radius: 16px !important; margin-bottom: 12px; background: var(--card-bg); overflow: hidden; box-shadow: 0 6px 20px rgba(0,0,0,0.025); }
        .accordion-header { padding: 12px 16px; background: var(--card-bg); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .accordion-header:hover { background: rgba(128,128,128,0.05); }
        .accordion-header .date { font-weight: bold; font-size: 1.05rem; color: var(--text-main); }
        .accordion-header .summary { color: #007AFF; font-weight: 700; font-size: 1.05rem; }
        .accordion-body { background: var(--app-bg); padding: 15px 16px; border-top: 1px solid var(--border-color); animation: slideIn 0.2s ease-out; position: relative; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-sub); }
        .text-dark-adaptive { color: #000; } @media (prefers-color-scheme: dark) { .text-dark-adaptive { color: #FFF; } }
        .arrow { transition: transform 0.3s; font-size: 12px; color: var(--text-sub); margin-left: 10px; display: inline-block; } .arrow.rotated { transform: rotate(180deg); }
        
        .custom-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--modal-overlay); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .custom-modal { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 24px; width: 90%; max-width: 400px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); animation: popIn 0.2s ease-out; color: var(--text-main); }
        .full-screen-modal { width: 95%; max-width: 800px; height: 90%; display: flex; flex-direction: column; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .form-control, .form-select { background-color: var(--input-bg); border-color: var(--input-border); color: var(--text-main); border-radius: 10px; }
        .form-control:focus, .form-select:focus { background-color: var(--input-bg); color: var(--text-main); border-color: #007AFF; box-shadow: 0 0 0 0.2rem rgba(0,122,255,0.25); }
        .icon-btn { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: background-color 0.2s, transform 0.1s; user-select: none; }
        .icon-btn:active { transform: scale(0.92); background-color: var(--icon-btn-active); }
        .icon-btn.active { background-color: var(--nav-bg-active); color: #007AFF; }
        .icon-btn.active ion-icon { color: #007AFF; }
        ion-icon { font-size: 24px; color: var(--icon-color); --ionicon-stroke-width: 40px; transition: color 0.3s; }
        
        .date-range-badge { font-size: 0.75rem; color: var(--text-sub); background: var(--badge-bg); padding: 2px 8px; border-radius: 6px; font-family: Menlo, Monaco, Consolas, "Courier New", monospace; }
        .fade-slide-enter-active, .fade-slide-leave-active { transition: opacity 0.2s; }
        .fade-slide-enter-from, .fade-slide-leave-to { opacity: 0; display: none; }
        
        .table { --bs-table-bg: transparent; --bs-table-color: var(--text-main); color: var(--text-main); }
        .table-borderless td, .table-borderless th { border: none; }
        .border-bottom { border-bottom: 1px solid var(--border-color) !important; }
        th { white-space: nowrap; color: var(--text-sub); font-weight: 600; }
        @media (prefers-color-scheme: dark) { th { color: var(--text-main) !important; } }
        .text-muted { color: var(--text-sub) !important; } .fw-bold { color: var(--text-main) !important; }
        .nickname-text { font-weight: 400; font-size: 0.95rem; color: var(--text-main) !important; }
        .text-primary { color: #007AFF !important; } @media (prefers-color-scheme: dark) { .text-primary { color: #0A84FF !important; } }
        
        .node-row { display: flex; align-items: center; padding: 16px 20px; background: var(--card-bg); border-radius: 24px; margin-bottom: 12px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s; }
        .node-row:active { transform: scale(0.98); } .node-row.selected { background: var(--card-bg); border-color: #34C759; }
        .node-status-dot { width: 10px; height: 10px; border-radius: 50%; margin: 0; }
        .node-status-dot.online { background: #34C759; box-shadow: 0 0 8px rgba(52, 199, 89, 0.5); }
        .node-status-dot.offline { background: #8E8E93; }
        .del-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.2s; color: #FF3B30; }
        .del-btn ion-icon { color: #FF3B30; } .del-btn:hover { background: rgba(255, 59, 48, 0.1); }
        .log-modal-body { flex: 1; overflow-y: auto; padding: 0 10px; }

        .top-blur-mask { position: fixed; top: 0; left: 0; right: 0; height: calc(env(safe-area-inset-top) + 80px); z-index: 9999; pointer-events: none; background: linear-gradient(to bottom, rgba(0,0,0,0.02) 0%, rgba(244, 243, 249, 0.5) 30%, rgba(244, 243, 249, 0) 100%); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 30%, rgba(0,0,0,0) 100%); -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 30%, rgba(0,0,0,0) 100%); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .top-blur-mask.show { opacity: 1; visibility: visible; }
        @media (prefers-color-scheme: dark) { .top-blur-mask { background: linear-gradient(to bottom, rgba(0,0,0,0.2) 0%, rgba(0, 0, 0, 0.6) 30%, rgba(0, 0, 0, 0) 100%); } }

        .ios-search-bar { display: flex; align-items: center; background: rgba(118, 118, 128, 0.12); border-radius: 12px; padding: 0 12px; height: 40px; margin-bottom: 16px; box-sizing: border-box; }
        @media (prefers-color-scheme: dark) { .ios-search-bar { background: rgba(118, 118, 128, 0.24); } }
        .ios-search-icon { color: var(--text-sub); font-size: 18px; margin-right: 6px; }
        .ios-search-select { border: none; background: transparent; color: var(--text-main); font-weight: 500; font-size: 0.95rem; outline: none; appearance: none; -webkit-appearance: none; cursor: pointer; padding: 0; }
        .ios-search-divider { width: 1px; height: 16px; background: var(--text-sub); opacity: 0.3; margin: 0 12px; }
        .ios-search-input { flex: 1; border: none; background: transparent; color: var(--text-main); font-size: 0.95rem; outline: none; min-width: 0; }
        .ios-search-input::placeholder { color: var(--text-sub); }
        .clear-icon { color: var(--text-sub); font-size: 18px; cursor: pointer; opacity: 0.6; transition: 0.2s; } .clear-icon:active { opacity: 1; }
        
        .filter-summary-card { background: var(--app-bg); border-radius: 24px; padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border: 1px solid var(--border-color); }
        .user-select-row { padding: 14px 12px; border-radius: 10px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid var(--border-color); }
        .user-select-row:last-child { border-bottom: none; } .user-select-row:active { background: var(--icon-btn-active); transform: scale(0.98); }
        
        .adv-filter-btn { background: rgba(0, 122, 255, 0.1); color: #007AFF; border-radius: 12px; padding: 12px; text-align: center; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: 0.2s; user-select: none; }
        .adv-filter-btn:active { transform: scale(0.98); background: rgba(0, 122, 255, 0.15); }
        @media (prefers-color-scheme: dark) { .adv-filter-btn { background: rgba(10, 132, 255, 0.15); color: #0A84FF; } }
        
        .ios-date-input { width: 100%; box-sizing: border-box; background: rgba(118, 118, 128, 0.12); border: none; color: var(--text-main); border-radius: 10px; font-size: 0.95rem; padding: 10px 12px; outline: none; font-family: inherit; }
        @media (prefers-color-scheme: dark) { .ios-date-input::-webkit-calendar-picker-indicator { filter: invert(1); } }
    </style>
</head>
<body>
{% raw %}
<div id="app" v-cloak>
    <div id="dynamic-top-mask" class="top-blur-mask"></div>

    <div class="custom-modal-overlay" v-if="settingsModal.show">
        <div class="custom-modal">
            <h5 class="fw-bold mb-3">æ•°æ®è§†å›¾åˆ‡æ¢</h5>
            <div class="mb-4">
                <label class="form-label text-muted small">é€‰æ‹©å½“å‰èŠ‚ç‚¹è¦æŸ¥çœ‹çš„ä¸šåŠ¡æ•°æ®</label>
                <select class="form-select" v-model="settingsModal.templateId">
                    <option v-for="t in availableTemplates" :value="t.id">{{ t.name }}</option>
                </select>
                <div class="mt-2 small text-muted">æç¤ºï¼šå®¢æˆ·ç«¯ä¼šè‡ªåŠ¨è¯†åˆ«æ—¥å¿—ç±»å‹ï¼Œæ‚¨åªéœ€åœ¨æ­¤åˆ‡æ¢æŸ¥çœ‹å¯¹åº”çš„ç»Ÿè®¡é¢æ¿ã€‚</div>
            </div>
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-secondary rounded-pill px-4" @click="settingsModal.show = false">å–æ¶ˆ</button>
                <button class="btn btn-primary rounded-pill px-4" @click="saveNodeSettings">æŸ¥çœ‹</button>
            </div>
        </div>
    </div>

    <div class="custom-modal-overlay" v-if="userFilterModal.show">
        <div class="custom-modal">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold m-0">å†å²æŸ¥è¯¢</h5>
                <div class="icon-btn" @click="userFilterModal.show = false"><ion-icon name="close"></ion-icon></div>
            </div>
            
            <div class="adv-filter-btn mb-3" @click="userFilterModal.showAdvanced = !userFilterModal.showAdvanced">
                <ion-icon :name="userFilterModal.showAdvanced ? 'chevron-up-outline' : 'options-outline'" style="font-size: 16px; margin-right: 4px; vertical-align: text-bottom;"></ion-icon>
                {{ userFilterModal.showAdvanced ? 'æ”¶èµ·é«˜çº§ç­›é€‰' : 'é«˜çº§ç­›é€‰ (æ—¶é—´ / æœç´¢)' }}
            </div>

            <transition name="fade-slide">
                <div v-show="userFilterModal.showAdvanced" class="mb-3 p-3" style="background: var(--app-bg); border-radius: 16px; border: 1px solid var(--border-color);">
                    <div class="d-flex flex-column gap-2 mb-3">
                        <input type="text" class="ios-date-input w-100" placeholder="èµ·å§‹æ—¶é—´ (å¯é€‰)" onfocus="this.type='datetime-local'" onblur="if(!this.value) this.type='text'" v-model="userFilterModal.startDate">
                        <input type="text" class="ios-date-input w-100" placeholder="ç»“æŸæ—¶é—´ (å¯é€‰)" onfocus="this.type='datetime-local'" onblur="if(!this.value) this.type='text'" v-model="userFilterModal.endDate">
                    </div>
                    
                    <div class="d-flex align-items-center gap-2">
                        <div class="ios-search-bar m-0" style="flex: 1; min-width: 0; height: 40px;">
                            <ion-icon name="search" class="ios-search-icon"></ion-icon>
                            <input type="text" class="ios-search-input w-100" placeholder="æ¨¡ç³Šç­›é€‰æ˜µç§°..." v-model="userFilterModal.searchText" @keyup.enter="executeSearch">
                            <ion-icon name="close-circle" class="clear-icon" v-show="userFilterModal.searchText" @click="userFilterModal.searchText = ''"></ion-icon>
                        </div>
                        <button class="btn btn-primary rounded-pill m-0" style="flex-shrink: 0; height: 40px; padding: 0 20px; font-weight: 600; white-space: nowrap;" @click="executeSearch">æŸ¥è¯¢</button>
                    </div>
                </div>
            </transition>

            <div class="text-muted small fw-bold mb-2 ps-1">å¿«æ·é€‰æ‹©åå•</div>
            <div style="max-height: 35vh; overflow-y: auto; padding-right: 5px;">
                <div v-if="userFilterModal.loading" class="text-center py-4 text-muted">åŠ è½½ä¸­...</div>
                <div v-else-if="filteredUserList.length === 0" class="text-center py-4 text-muted">æ— åŒ¹é…ç”¨æˆ·</div>
                <div v-for="user in filteredUserList" :key="user" class="user-select-row d-flex justify-content-between align-items-center" @click="applyUserFilter(user)">
                    <span class="nickname-text fw-bold">{{ hideNicknames ? '***' : user }}</span>
                    <ion-icon name="chevron-forward" style="font-size: 16px; color: var(--text-sub); opacity: 0.5;"></ion-icon>
                </div>
            </div>
        </div>
    </div>

    <div class="custom-modal-overlay" v-if="editModal.show">
        <div class="custom-modal">
            <h5 class="fw-bold mb-3">ä¿®æ­£å†å²æ•°æ®</h5>
            <div class="mb-3"><label class="form-label text-muted small">æ—¥æœŸ</label><input class="form-control" v-model="editModal.data.field1" disabled></div>
            <div class="mb-4"><label class="form-label text-muted small">æ€»æ”¶ç›Š</label><input type="number" class="form-control" v-model.number="editModal.data.field2"></div>
            <div class="mb-4"><label class="form-label text-muted small">å‚ä¸è´¦å·æ•°é‡</label><input type="number" class="form-control" v-model.number="editModal.data.field3"></div>
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-secondary rounded-pill px-4" @click="closeModal">å–æ¶ˆ</button>
                <button class="btn btn-primary rounded-pill px-4" @click="saveEdit">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="custom-modal-overlay" v-if="authModal.show">
        <div class="custom-modal">
            <h5 class="fw-bold mb-3">è¯·è¾“å…¥èŠ‚ç‚¹å¯†ç </h5>
            <div class="mb-3"><input type="password" class="form-control" v-model="authModal.password" placeholder="è¯¥èŠ‚ç‚¹å·²åŠ å¯†" @keyup.enter="confirmPassword"></div>
            <div class="mb-4 form-check"><input class="form-check-input" type="checkbox" id="rememberCheck" v-model="authModal.remember"><label class="form-check-label small text-muted" for="rememberCheck">è®°ä½å¯†ç </label></div>
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-secondary rounded-pill px-4" @click="authModal.show = false">å–æ¶ˆ</button>
                <button class="btn btn-primary rounded-pill px-4" @click="confirmPassword">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div class="custom-modal-overlay" v-if="historyLogsModal.show">
        <div class="custom-modal full-screen-modal">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold m-0">{{ historyLogsModal.date }} è¯¦æƒ…</h5>
                <div class="icon-btn" @click="historyLogsModal.show = false"><ion-icon name="close"></ion-icon></div>
            </div>
            <div class="log-modal-body">
                <div v-if="historyLogsModal.loading" class="text-center py-5 text-muted">åŠ è½½ä¸­...</div>
                <div v-else-if="historyLogsModal.logs.length === 0" class="text-center py-5 text-muted">å½“æ—¥æ— æ•°æ®</div>
                <table v-else class="table table-borderless align-middle">
                    <thead class="small border-bottom"><tr><th>æ—¶é—´</th><th>ç”¨æˆ·</th><th class="text-end">æ˜ç»†</th></tr></thead>
                    <tbody>
                        <tr v-for="log in historyLogsModal.logs" class="border-bottom">
                            <td class="text-muted small">{{ log.log_time.split(' ')[1] || log.log_time }}</td>
                            <td class="nickname-text">{{ hideNicknames ? '***' : log.nickname }}</td>
                            <td class="text-end align-middle" style="padding-top: 10px; padding-bottom: 10px;">
                                <div v-if="log.item_type && log.item_type !== 'é’»çŸ³'" class="text-success small mb-1" style="font-size: 0.75rem; white-space: normal; line-height: 1.2; word-break: break-all; text-align: right;">
                                    {{ log.item_type }}
                                </div>
                                <span class="text-primary fw-bold" style="font-size: 1.1rem; min-width: 40px; text-align: right;">
                                    <template v-if="log.item_type === 'é’»çŸ³'">{{ log.quantity }}</template>
                                    <template v-else>+{{ log.quantity }}</template>
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="scale-container">
        
        <transition name="fade-slide"><div v-show="curPage===1">
            <div class="page-header justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <h1 class="big-title pe-2" style="font-size: 28px;">æœ¬è½®æ¦‚è§ˆ</h1>
                    <div class="icon-btn" @click="resetRound" title="é‡æ–°å¼€å§‹æ–°ä¸€è½®" style="width: 28px; height: 28px;">
                        <ion-icon name="refresh-outline" style="font-size: 18px;"></ion-icon>
                    </div>
                    <div class="icon-btn ms-2" @click="openNodeSettings" title="æ•°æ®è§†å›¾åˆ‡æ¢" style="width: 28px; height: 28px;">
                        <ion-icon name="options-outline" style="font-size: 18px;"></ion-icon>
                    </div>
                </div>
                <div class="status-badge" :class="getStatusTypeClass(stats.process_status)" v-if="stats.process_status">
                    <div class="static-dot"></div>
                    <span>{{ getStatusText(stats.process_status) }}</span>
                </div>
            </div>

            <div class="row g-2 mb-4">
                <div class="col-6"><div class="hl-card"><div class="hl-num num-account">{{ stats.total_users || 0 }}</div><div class="hl-label">è´¦å·æ•°é‡</div></div></div>
                <div class="col-6"><div class="hl-card"><div class="hl-num num-total">{{ stats.total_wins || 0 }}</div><div class="hl-label">æœ¬è½®äº§å‡º</div></div></div>
            </div>

            <div class="d-flex align-items-center mb-2 px-2">
                <span class="fw-bold" style="font-size: 1.4rem; color: var(--text-main); letter-spacing: -0.01em;">æ”¶ç›Šæ’è¡Œ</span>
                <div class="icon-btn ms-2" style="width: 28px; height: 28px;" @click="hideNicknames = !hideNicknames" title="éšç§æ¨¡å¼"><ion-icon :name="hideNicknames ? 'eye-off-outline' : 'eye-outline'" style="font-size: 18px;"></ion-icon></div>
                <span class="date-range-badge ms-auto" v-if="stats.date_range">{{ stats.date_range }}</span>
            </div>

            <div class="apple-card mt-0">
                <div class="rank-container">
                    <div v-for="(user, i) in stats.rank_list" :key="i" class="list-row">
                        <div class="d-flex align-items-center flex-grow-1" style="min-width: 0;"><div class="nickname-text text-truncate pe-2">{{ hideNicknames ? '***' : user.nickname }}</div></div>
                        <div class="d-flex align-items-center"><span class="text-muted small me-3" style="font-weight: 500;">{{ user.win_times }} æ¬¡</span><span class="text-primary fw-bold" style="font-size: 1.1rem; min-width: 40px; text-align: right;">{{ user.win_sum }}</span></div>
                    </div>
                    <div v-if="stats.rank_list.length===0" class="text-center text-muted py-3">æš‚æ— æ•°æ®</div>
                </div>
            </div>
        </div></transition>

        <transition name="fade-slide"><div v-show="curPage===2">
            <div class="page-header justify-content-between align-items-center">
                <h1 class="big-title">æ—¥å¿—æ˜ç»†</h1>
                <div class="d-flex align-items-center"><div class="icon-btn" :class="{ 'active': filterSmallPacks }" @click="filterSmallPacks = !filterSmallPacks" title="è¿‡æ»¤å°åŒ… (<24)"><ion-icon :name="filterSmallPacks ? 'funnel' : 'funnel-outline'"></ion-icon></div></div>
            </div>

            <div class="apple-card mt-0">
                <div class="ios-search-bar">
                    <ion-icon name="search" class="ios-search-icon"></ion-icon>
                    <select class="ios-search-select" v-model="searchType"><option value="nick">æ˜µç§°</option><option value="date">æ—¥æœŸ</option></select>
                    <ion-icon name="chevron-down" style="font-size: 12px; color: var(--text-sub); margin-left: 2px; pointer-events: none;"></ion-icon>
                    <div class="ios-search-divider"></div>
                    <input type="text" class="ios-search-input" placeholder="è¾“å…¥æœç´¢å†…å®¹..." v-model="searchText">
                    <ion-icon name="close-circle" class="clear-icon" v-show="searchText" @click="searchText = ''"></ion-icon>
                </div>
                <transition name="fade-slide">
                    <div class="filter-summary-card" v-if="filterSmallPacks">
                        <span class="text-muted fw-bold" style="font-size: 0.9rem;">å¤§åŒ…æ€»è®¡æ•°é‡ <span style="font-weight: 400; font-size: 0.8rem;">(å·²è¿‡æ»¤å°åŒ…)</span></span><span class="text-primary fw-bold" style="font-size: 1.2rem;">{{ filteredTotal }}</span>
                    </div>
                </transition>
                <div style="max-height: 65vh; overflow-y: auto;">
                    <table class="table table-borderless align-middle m-0">
                        <thead class="small border-bottom"><tr><th style="padding-bottom: 10px;"><div class="d-flex align-items-center"><span>ç”¨æˆ· / æ—¶é—´</span><div class="icon-btn ms-1" style="width:28px; height:28px;" @click="hideNicknames = !hideNicknames"><ion-icon :name="hideNicknames ? 'eye-off-outline' : 'eye-outline'" style="font-size: 18px;"></ion-icon></div></div></th><th class="text-end" style="padding-bottom: 10px;">æ˜ç»†</th></tr></thead>
                        <tbody><tr v-for="item in filteredDetails" class="border-bottom"><td class="py-3">
                            <div class="nickname-text text-truncate" style="max-width: 220px;">{{ hideNicknames ? '***' : item.nickname }}</div>
                            <div class="text-muted small" style="font-size: 0.75rem; margin-top: 4px;">{{ item.log_time }}</div>
                        </td><td class="text-end py-3 align-middle">
                            <div v-if="item.item_type && item.item_type !== 'é’»çŸ³'" class="text-success small mb-1" style="font-size: 0.75rem; white-space: normal; line-height: 1.2; word-break: break-all; text-align: right;">
                                {{ item.item_type }}
                            </div>
                            <span class="text-primary fw-bold" style="font-size: 1.1rem; min-width: 40px; text-align: right;">
                                <template v-if="item.item_type === 'é’»çŸ³'">{{ item.quantity }}</template>
                                <template v-else>+{{ item.quantity }}</template>
                            </span>
                        </td></tr></tbody>
                    </table>
                </div>
            </div>
        </div></transition>

        <transition name="fade-slide"><div v-show="curPage===3">
            <div class="page-header justify-content-between">
                <h1 class="big-title">å†å²è®°å½•</h1>
                <div class="d-flex align-items-center gap-1">
                    <div class="icon-btn" @click="hideHistory = !hideHistory" title="éšç§å¼€å…³"><ion-icon :name="hideHistory ? 'eye-off-outline' : 'eye-outline'"></ion-icon></div>
                    <div class="icon-btn" @click="handleHistoryEdit" title="ä¿®æ”¹å±•å¼€é¡¹"><ion-icon name="create-outline"></ion-icon></div>
                    <div class="icon-btn" @click="openUserFilter" :class="{ 'active': historyFilterUser }" title="ç­›é€‰æŸ¥è¯¢"><ion-icon :name="historyFilterUser ? 'funnel' : 'funnel-outline'"></ion-icon></div>
                </div>
            </div>
            
            <transition name="fade-slide">
                <div class="filter-summary-card mb-3" v-if="historyFilterUser" style="background: linear-gradient(135deg, rgba(0,122,255,0.08), rgba(52,199,89,0.05)); border: 1px solid rgba(0,122,255,0.2);">
                    <div style="flex: 1; min-width: 0; padding-right: 15px;">
                        <div class="text-muted fw-bold" style="font-size: 0.85rem;">ç´¯è®¡äº§å‡º</div>
                        <div class="nickname-text mt-1 fw-bold text-truncate" style="font-size: 1.15rem; color: var(--text-main);">
                            {{ hideNicknames && historyFilterUser !== 'ã€å…¨èŠ‚ç‚¹æ—¶æ®µæ€»å’Œã€‘' ? '***' : historyFilterUser }}
                        </div>
                        <div class="text-muted mt-1" style="font-size: 0.75rem; font-weight: 500; line-height: 1.2;">
                            {{ historyFilterDateRange }}
                        </div>
                    </div>
                    <div class="d-flex align-items-center flex-shrink-0">
                        <span class="text-primary fw-bold me-3" style="font-size: 2.6rem; line-height: 1; font-family: ui-rounded, 'SF Pro Rounded', sans-serif;">{{ historyFilterTotal }}</span>
                        <div class="icon-btn" style="width: 32px; height: 32px; background: rgba(0,0,0,0.05);" @click="clearUserFilter" title="æ¸…é™¤ç­›é€‰">
                            <ion-icon name="close" style="font-size: 16px; color: var(--text-main);"></ion-icon>
                        </div>
                    </div>
                </div>
            </transition>

            <div v-if="!stats.history_data || stats.history_data.length===0" class="text-center text-muted py-5">æš‚æ— å†å²æ•°æ®</div>
            <div class="accordion-item" v-for="day in stats.history_data" :key="day.date">
                <div class="accordion-header" @click="toggleDate(day.date)">
                    <div class="d-flex align-items-center"><span class="date">{{ day.date }}</span><span class="badge bg-warning text-dark ms-2" v-if="day.is_manual">å·²ä¿®æ­£</span></div>
                    <div class="d-flex align-items-center"><span class="summary text-primary me-2">{{ (hideHistory && !expandedDates[day.date]) ? '**' : ('+' + day.daily_sum) }}</span><span class="arrow" :class="{ rotated: expandedDates[day.date] }">â–¼</span></div>
                </div>
                <div class="accordion-body" v-if="expandedDates[day.date]">
                    <div class="detail-row"><span>ğŸ‘¥ å‚ä¸è´¦å·æ•°é‡</span><span class="fw-bold text-dark-adaptive">{{ day.user_count }}</span></div>
                    <div class="detail-row"><span>ğŸ’° å½“æ—¥æ€»æ”¶ç›Š</span><span class="fw-bold text-dark-adaptive">{{ day.daily_sum }}</span></div>
                    <div class="mt-3 text-end"><button class="btn btn-sm btn-outline-primary rounded-pill px-3" @click="viewHistoryLogs(day.date)">æŸ¥çœ‹è¯¦ç»†æ•°æ®</button></div>
                </div>
            </div>
        </div></transition>

        <transition name="fade-slide"><div v-show="curPage===4">
            <div class="page-header justify-content-between">
                <h1 class="big-title">èŠ‚ç‚¹é€‰æ‹©</h1>
                <div class="icon-btn" @click="isManageMode = !isManageMode" :class="{active: isManageMode}" title="ç®¡ç†èŠ‚ç‚¹"><ion-icon name="create-outline"></ion-icon></div>
            </div>
            <div v-if="nodeList.length === 0" class="text-center text-muted py-5"><ion-icon name="server-outline" style="font-size: 48px; opacity: 0.5; margin-bottom: 10px;"></ion-icon><div>æš‚æ— èŠ‚ç‚¹</div></div>
            <div v-for="node in nodeList" :key="node.device_id" class="node-row" :class="{selected: curNodeId === node.device_id}" @click="selectNode(node)">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-1">
                        <span class="fw-bold me-2" style="font-size: 1.05rem;">{{ node.nickname }}</span>
                        <ion-icon name="lock-closed" v-if="node.has_password" style="font-size: 14px; color: #8E8E93;"></ion-icon>
                        <span v-if="curNodeId === node.device_id" class="badge bg-success rounded-pill ms-2" style="font-size: 0.6rem;">å½“å‰</span>
                    </div>
                    <div class="text-muted small" style="font-family: monospace;">ID: {{ node.device_id.substring(0, 8) }}...</div>
                </div>
                <div class="d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; flex-shrink: 0;">
                    <div class="node-status-dot" :class="node.is_online ? 'online' : 'offline'" v-if="!isManageMode"></div>
                    <div class="del-btn w-100 h-100" v-if="isManageMode" @click.stop="deleteNode(node)"><ion-icon name="remove-circle"></ion-icon></div>
                </div>
            </div>
        </div></transition>

    </div>

    <nav class="bottom-nav">
        <div class="nav-tabs-c">
            <a class="nav-item-c" :class="{active: curPage===1}" @click="changeTab(1)">æ€»è§ˆ</a>
            <a class="nav-item-c" :class="{active: curPage===2}" @click="changeTab(2)">æ˜ç»†</a>
            <a class="nav-item-c" :class="{active: curPage===3}" @click="changeTab(3)">å†å²</a>
            <a class="nav-item-c" :class="{active: curPage===4}" @click="changeTab(4)">èŠ‚ç‚¹</a>
        </div>
    </nav>
</div>
{% endraw %}

<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const curPage = ref(1);
            const expandedDates = ref({}); 
            const stats = ref({ process_status: "æœªçŸ¥", current_template: "default", total_users: 0, total_wins: 0, rank_list: [], details: [], history_data: [], date_range: "" });
            const searchText = ref(""); const searchType = ref("nick"); const filterSmallPacks = ref(false);
            const editModal = ref({ show: false, data: { field1: '', field2: 0, field3: 0 } });
            const authModal = ref({ show: false, password: "", remember: false, targetNode: null }); 
            const historyLogsModal = ref({ show: false, loading: false, date: "", logs: [] });
            
            const historyFilterUser = ref(""); const historyFilterTotal = ref(0); const historyFilterDateRange = ref("");
            const userFilterModal = ref({ show: false, showAdvanced: false, loading: false, users: [], searchText: "", startDate: "", endDate: "" });

            const availableTemplates = ref([]);
            const settingsModal = ref({ show: false, templateId: "default" });

            const hideNicknames = ref(false); const hideHistory = ref(false);
            const nodeList = ref([]); const curNodeId = ref(""); const curNodeName = ref("");
            const curPassword = ref(""); const isAuthError = ref(false); const isManageMode = ref(false);

            const changeTab = (page) => { curPage.value = page; isManageMode.value = false; window.scrollTo({ top: 0, behavior: 'smooth' }); };

            const loadTemplates = async () => {
                try {
                    const res = await axios.get('/api/templates');
                    availableTemplates.value = res.data.templates || [];
                } catch(e) { console.error(e); }
            };

            const loadNodes = async () => {
                try {
                    const res = await axios.get('/api/nodes');
                    nodeList.value = res.data.nodes;
                    if ((!curNodeId.value) && nodeList.value.length > 0) {
                        const lastId = localStorage.getItem('last_node_id');
                        const target = nodeList.value.find(n => n.device_id === lastId) || nodeList.value[0];
                        selectNode(target); 
                    }
                } catch(e) {}
            };

            const selectNode = (node) => {
                if (isManageMode.value) return; 
                isAuthError.value = false;
                localStorage.setItem('last_node_id', node.device_id);
                curNodeId.value = node.device_id; curNodeName.value = node.nickname;
                clearUserFilter();
                const savedPass = localStorage.getItem(`pwd_${node.device_id}`);
                if (node.has_password) {
                    if (savedPass) { curPassword.value = savedPass; loadData(); } 
                    else {
                        curPassword.value = ""; authModal.value.targetNode = node; authModal.value.password = ""; authModal.value.remember = false; authModal.value.show = true;
                        stats.value = { process_status: "ğŸ”’ æ— æƒé™", total_users: 0, total_wins: 0, rank_list: [], details: [], history_data: [], date_range: "" };
                    }
                } else { curPassword.value = ""; loadData(); }
            };

            const confirmPassword = () => {
                curPassword.value = authModal.value.password;
                if (authModal.value.remember && authModal.value.targetNode) localStorage.setItem(`pwd_${authModal.value.targetNode.device_id}`, authModal.value.password);
                authModal.value.show = false; isAuthError.value = false; loadData();
            };

            const deleteNode = async (node) => {
                if(!confirm(`ç¡®å®šè¦åˆ é™¤èŠ‚ç‚¹ "${node.nickname}" å—ï¼Ÿ\nåˆ é™¤åå¦‚æœèŠ‚ç‚¹é‡æ–°ä¸Šçº¿ï¼Œå®ƒä¼šè‡ªåŠ¨æ¢å¤ã€‚`)) return;
                try {
                    await axios.post('/api/node/delete', { device_id: node.device_id });
                    if (curNodeId.value === node.device_id) { curNodeId.value = ""; curNodeName.value = ""; localStorage.removeItem('last_node_id'); }
                    await loadNodes(); 
                } catch(e) { alert("åˆ é™¤å¤±è´¥"); }
            };

            const loadData = async () => {
                if (!curNodeId.value) return;
                try {
                    const res = await axios.get(`/api/stats?node_id=${encodeURIComponent(curNodeId.value)}&password=${encodeURIComponent(curPassword.value)}`);
                    stats.value = res.data;
                    isAuthError.value = false;
                } catch(e) {
                    if (e.response && e.response.status === 403) {
                        stats.value = { process_status: "ğŸ”’ æ— æƒé™", total_users: 0, total_wins: 0, rank_list: [], details: [], history_data: [], date_range: "" };
                        if (!isAuthError.value) {
                            alert("å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥"); isAuthError.value = true; curPassword.value = ""; 
                            if (localStorage.getItem(`pwd_${curNodeId.value}`)) localStorage.removeItem(`pwd_${curNodeId.value}`);
                            const node = nodeList.value.find(n => n.device_id === curNodeId.value);
                            if (node) { authModal.value.targetNode = node; authModal.value.password = ""; authModal.value.show = true; }
                        }
                    }
                }
            };

            const openNodeSettings = () => {
                if (!curNodeId.value) return;
                settingsModal.value.templateId = stats.value.current_template || "default";
                settingsModal.value.show = true;
            };

            const saveNodeSettings = async () => {
                try {
                    await axios.post('/api/set_template', { node_id: curNodeId.value, template_id: settingsModal.value.templateId });
                    settingsModal.value.show = false; clearUserFilter(); loadData();
                } catch(e) { alert("ä¿å­˜è®¾ç½®å¤±è´¥"); }
            };

            const resetRound = async () => {
                if (!curNodeId.value) return;
                if (!confirm("ç¡®è®¤è¦å¼€å¯æ–°ä¸€è½®ç»Ÿè®¡å—ï¼Ÿ\nå½“å‰çš„å±•ç¤ºæ•°æ®å°†ä¼šæ¸…é›¶ï¼Œä½†ä¸ä¼šå½±å“å†å²é¡µé¢çš„é•¿æœŸæ•°æ®è®°å½•ã€‚")) return;
                try { await axios.post('/api/reset_round', { device_id: curNodeId.value }); await loadData(); } catch(e) { alert("é‡ç½®å¤±è´¥"); }
            };

            const openUserFilter = async () => {
                if (!curNodeId.value) return;
                userFilterModal.value.show = true; 
                userFilterModal.value.showAdvanced = false; 
                userFilterModal.value.loading = true; userFilterModal.value.searchText = ""; userFilterModal.value.users = [];
                try {
                    const res = await axios.get(`/api/user_total?node_id=${curNodeId.value}`);
                    userFilterModal.value.users = res.data.users || [];
                } catch (e) { console.error("åŠ è½½å¤±è´¥"); } finally { userFilterModal.value.loading = false; }
            };

            const filteredUserList = computed(() => {
                const raw = userFilterModal.value.searchText.trim().toLowerCase();
                if (!raw) return userFilterModal.value.users;
                return userFilterModal.value.users.filter(u => u.toLowerCase().includes(raw));
            });

            const executeSearch = () => {
                const raw = userFilterModal.value.searchText.trim();
                if (!raw) {
                    if (!userFilterModal.value.startDate && !userFilterModal.value.endDate) {
                        alert("å¦‚æœæŸ¥è¯¢å…¨èŠ‚ç‚¹ï¼Œè¯·è‡³å°‘è®¾ç½®ä¸€ä¸ªã€èµ·å§‹æ—¶é—´ã€‘æˆ–ã€ç»“æŸæ—¶é—´ã€‘ï¼"); return;
                    }
                    queryAllUsers();
                } else {
                    applyUserFilter(raw);
                }
            };

            const queryAllUsers = async () => {
                historyFilterUser.value = "ã€å…¨èŠ‚ç‚¹æ—¶æ®µæ€»å’Œã€‘"; 
                userFilterModal.value.show = false; 
                historyFilterTotal.value = "...";
                
                let ds = userFilterModal.value.startDate; let de = userFilterModal.value.endDate;
                let query = `/api/user_total?node_id=${curNodeId.value}&calc_all=1`;
                
                if (ds) query += `&start_date=${ds}`; if (de) query += `&end_date=${de}`;
                historyFilterDateRange.value = `${ds ? ds.replace('T', ' ') : 'æœ€æ—©æœŸ'} è‡³ ${de ? de.replace('T', ' ') : 'æœ€æ–°'}`;
                
                try { const res = await axios.get(query); historyFilterTotal.value = res.data.total || 0; } 
                catch (e) { historyFilterTotal.value = 0; }
            };

            const applyUserFilter = async (nickname) => {
                historyFilterUser.value = nickname; userFilterModal.value.show = false; historyFilterTotal.value = "...";
                let ds = userFilterModal.value.startDate; let de = userFilterModal.value.endDate;
                let query = `/api/user_total?node_id=${curNodeId.value}&nickname=${encodeURIComponent(nickname)}`;
                
                if (ds) query += `&start_date=${ds}`; if (de) query += `&end_date=${de}`;
                if (!ds && !de) historyFilterDateRange.value = "æ‰€æœ‰æ—¶é—´"; else historyFilterDateRange.value = `${ds ? ds.replace('T', ' ') : 'æœ€æ—©æœŸ'} è‡³ ${de ? de.replace('T', ' ') : 'æœ€æ–°'}`;
                
                try { const res = await axios.get(query); historyFilterTotal.value = res.data.total || 0; } catch (e) { historyFilterTotal.value = 0; }
            };

            const clearUserFilter = () => { historyFilterUser.value = ""; historyFilterTotal.value = 0; };

            const viewHistoryLogs = async (date) => {
                historyLogsModal.value.date = date; historyLogsModal.value.show = true; historyLogsModal.value.loading = true; historyLogsModal.value.logs = [];
                try {
                    const res = await axios.get(`/api/history_logs?node_id=${curNodeId.value}&date=${date}`);
                    historyLogsModal.value.logs = res.data.logs;
                } catch(e) { console.error(e); } finally { historyLogsModal.value.loading = false; }
            };

            const getStatusText = (status) => {
                if (!status) return 'æœªçŸ¥'; if (status === 'è¿è¡Œä¸­') return 'è¿è¡Œ'; if (status === 'æœªè¿è¡Œ') return 'åœ¨çº¿';
                if (status === 'ç¦»çº¿' || status === 'æœªè¿æ¥') return 'ç¦»çº¿'; if (status.includes('æ— æƒé™')) return 'æ— æƒé™';
                return status;
            };

            const getStatusTypeClass = (status) => {
                if (!status) return 'status-offline'; if (status === 'è¿è¡Œä¸­') return 'status-running'; if (status === 'æœªè¿è¡Œ') return 'status-standby';
                if (status === 'ç¦»çº¿' || status === 'æœªè¿æ¥') return 'status-offline'; if (status.includes('æ— æƒé™')) return 'status-warning';
                return 'status-offline';
            };

            const filteredDetails = computed(() => {
                if(!stats.value.details) return [];
                const rawSearch = searchText.value.trim();
                return stats.value.details.filter(i => {
                    if (filterSmallPacks.value && i.quantity < 24) return false;
                    if (!rawSearch) return true;
                    if (searchType.value === 'nick') return i.nickname.replace(/\s+/g, '').toLowerCase().includes(rawSearch.replace(/\s+/g, '').toLowerCase());
                    else return i.log_time.substring(0, 10).replace(/\D/g, '').includes(rawSearch.replace(/\D/g, ''));
                });
            });

            const filteredTotal = computed(() => { return filteredDetails.value.reduce((sum, item) => sum + item.quantity, 0); });
            const toggleDate = (date) => { expandedDates.value[date] = !expandedDates.value[date]; };

            const handleHistoryEdit = () => {
                const openedDates = Object.keys(expandedDates.value).filter(d => expandedDates.value[d]);
                if (openedDates.length === 0) { alert("å½“å‰æ— æ•°æ®å±•å¼€"); return; }
                const targetDate = openedDates[0]; const dayData = stats.value.history_data.find(d => d.date === targetDate);
                if (dayData) { editModal.value.data = { field1: dayData.date, field2: dayData.daily_sum, field3: dayData.user_count }; editModal.value.show = true; }
            };

            const closeModal = () => { editModal.value.show = false; };
            const saveEdit = async () => {
                try { await axios.post('/api/update_history', { date: editModal.value.data.field1, device_id: curNodeId.value, manual_sum: editModal.value.data.field2, manual_users: editModal.value.data.field3 }); editModal.value.show = false; loadData(); } 
                catch(e) { alert("ä¿å­˜å¤±è´¥"); }
            };

            onMounted(async () => {
                editModal.value.show = false;
                const topMask = document.getElementById('dynamic-top-mask');
                if (topMask) {
                    window.addEventListener('scroll', () => {
                        const st = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
                        if (st > 15) topMask.classList.add('show'); else topMask.classList.remove('show');
                    }, { passive: true });
                }

                await loadTemplates();
                await loadNodes();
                loadData();
                
                setInterval(() => { 
                    let shouldLoad = true;
                    if (authModal.value.show || settingsModal.value.show || userFilterModal.value.show) shouldLoad = false;
                    const node = nodeList.value.find(n => n.device_id === curNodeId.value);
                    if (node && node.has_password && !curPassword.value) shouldLoad = false;
                    if (curNodeId.value && shouldLoad) loadData(); 
                    loadNodes(); 
                }, 2000);
            });

            return { 
                curPage, changeTab, stats, searchText, searchType, filterSmallPacks, filteredDetails, filteredTotal,
                expandedDates, toggleDate, editModal, authModal, historyLogsModal, viewHistoryLogs,
                closeModal, saveEdit, confirmPassword, hideNicknames, hideHistory, handleHistoryEdit, deleteNode,
                nodeList, curNodeId, curNodeName, selectNode, isManageMode, getStatusText, getStatusTypeClass, resetRound,
                historyFilterUser, historyFilterTotal, historyFilterDateRange, userFilterModal, filteredUserList, openUserFilter, applyUserFilter, clearUserFilter,
                availableTemplates, settingsModal, openNodeSettings, saveNodeSettings, executeSearch
            };
        }
    }).mount('#app');
</script>
</body>
</html>